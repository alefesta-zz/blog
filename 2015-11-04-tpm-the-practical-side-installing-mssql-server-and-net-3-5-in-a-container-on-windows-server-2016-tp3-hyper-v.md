---
title: 'TPM (The Practical Side) : Installing MSSQL Server and .Net 3.5 in a container on Windows Server 2016 TP3 Hyper-V'
author: Administrator
layout: post
date: 2015-11-04
url: /tpm-the-practical-side-installing-mssql-server-and-net-3-5-in-a-container-on-windows-server-2016-tp3-hyper-v/
categories:
  - docker
  - Microsoft
  - Unicorns
tags:
  - docker
  - funny
  - unicorn

---
> <p align="center">
>   Ā, upane! ka upane! A step upward, another step upward!
> </p>

<p align="left">
  beside write my rants on identities and everything else from time to time I like to play in the old way, that means… “all black style”.
</p>

<p align="left">
  So let’s start from the facts:
</p>

  * <div align="left">
      I’m in love with docker
    </div>

  * <div align="left">
      I am an avid reader of <a href="https://twitter.com/frazelledazzell">@frazelledazzell</a> blog
    </div>

  * <div align="left">
      I remember the first time I saw a session of <a href="https://twitter.com/markrussinovich/">@markrussinovich</a> in 2001 at the teched (yes I’m that old…)
    </div>

<p align="left">
  what does that means? I love challenges that seems apparently not possible, but let’s start from the beginning.
</p>

<p align="left">
  Microsoft is doing a real great job porting @docker on windows and released the TP3 of Windows Server 2016 who provide <strong>Docker version 1.9.0-dev, build 4376380</strong>.
</p>

<p align="left">
  You may read everything on <a href="https://msdn.microsoft.com/virtualization/windowscontainers/containers_welcome">here</a>
</p>

<p align="left">
  The actual version has some strict requirements:
</p>

  * <div align="left">
      System running Windows Server Technical Preview 3 Server Core.
    </div>

  * <div align="left">
      10GB available storage for OS Base Image and setup scripts.
    </div>

  * <div align="left">
      Administrator permissions on the machine or VM.
    </div>

<p align="left">
  but most of all got a quite long list of “things” who works or not works at all on containers. The list is  <a href="https://msdn.microsoft.com/virtualization/windowscontainers/reference/app_compat">here</a>
</p>

<p align="left">
  Now if you look at the list the first row in the table is quite interesting:
</p>

  * <div align="left">
      Name : .NET
    </div>

  * <div align="left">
      Version: 3,5
    </div>

  * <div align="left">
      Does it Work?: NO
    </div>

  * <div align="left">
      Comment :Fails to install properly
    </div>

<p align="left">
  And even more interesting there’s no mention of MSSQL server in the list!
</p>

<p align="left">
  So here’s the challenge is it possible to install .net 3.5 and MSSQL Server 2014 Standard Edition (that require .net 3.5) on a docker image?
</p>

<p align="left">
  in a word? YES
</p>

<p align="left">
  Okay let say I gave myself the answer before actually trying….but I’m an old nerd who love spend the long nights in the hotel trying new stuff and I do not easily give up on things.
</p>

<p align="left">
  now before go through the steps just a little disclaimer:
</p>

<p align="left">
  <strong>DISCLAIMER: THIS PROCEDURE IS TOTALLY UNSUPPORTED AND PRETTY SURE WILL BE NEVER BE SUPPORTED IT’S JUST AN HACK MADE TO DEMONSTRATE THAT IS TECHNICALLY POSSIBLE RUN A SPECIFIC SOFTWARE ON A SPECIFIC TECHNOLOGY</strong>
</p>

<h2 align="left">
  Create your own docker container
</h2>

<p align="left">
  Once your windows server 2016 TP3 got containers up and running and the windows core images ready create a base container.
</p>

<p align="left">
  Since we will need to run a graphical interface at some point enable the container to be used through RDP, you may get the steps <a href="https://msdn.microsoft.com/virtualization/windowscontainers/about/work_in_progress#DockermanagementDockercommandsthatdontworkwithWindowsServerContainers">here</a> (look for the paragraph “Accessing windows server container with Remote Desktop”)
</p>

<p align="left">
  <em>docker run –it –name mycontainer –hostname mycontainer  windowsservercore “cmd”</em>
</p>

<p align="left">
  At this point you got you’re container ready to be reached through RDP (i.e.: mstsc yourhostip:3390)
</p>

<p align="left">
  now the funny part:
</p>

<h2 align="left">
  Install .net 3.5
</h2>

<p align="left">
  When you install .net 3.5 you have to take care of two main points (at least to make it usable):
</p>

  * <div align="left">
      the path where the files are installed
    </div>

  * <div align="left">
      The registry keys who inform other applications that a certain version of .net is installed
    </div>

<p align="left">
  Do not try to install .net 3.5 through<em> powershell</em> since it will fail but use DISM instead.
</p>

<p align="left">
  Wait slow down kids, slow down do not run <em>dism</em> command yet.
</p>

<p align="left">
  Create a temporary folder on your image, it will be needed to copy the .net folders generated by the command before the command itself fail and delete everything.
</p>

<p align="left">
  Open another CMD window and after that you’re ready.
</p>

<p align="left">
  so type:
</p>

<p align="left">
  <strong>mkdir c:\yourtmpfolder</strong>
</p>

<p align="left">
  than switch to <strong>c:\Windows\Microsoft.NET\Framework64\</strong>
</p>

<p align="left">
  at this point run the command:
</p>

<p align="left">
  <strong>Dism /online /enable-feature /featurename:NetFx3 /All /LimitAccess /Source:d:\sources\sxs</strong>
</p>

<p align="left">
  monitor the Framework64 folder and when you see the .net 3.5 folders created issue the following command
</p>

<p align="left">
  <strong>xcopy * c:\youtpmfolder /E</strong>
</p>

<p align="left">
  re-run the command until the<em> dism</em> command fail
</p>

<p align="left">
  At this point copy back the folders in their supposed original position.
</p>

<p align="left">
  I had to run DISM 3 times to be sure I have everything copied correctly, I’m not sure if everything is really needed for MSSQL server so could be that only the .net 3.5 folder is really needed.
</p>

<p align="left">
  So we got now the files ready but we still miss the regedit part.
</p>

<p align="left">
  Open regedit (type regedit in the cmd window and hit enter…)
</p>

<p align="left">
  look for the branch:
</p>

<p align="left">
  <strong>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP</strong>
</p>

<p align="left">
  Create the following keys:
</p>

  * <div align="left">
      v2.0.50727
    </div>

  * <div align="left">
      v3.0
    </div>

  * <div align="left">
      v3.5
    </div>

<p align="left">
  click on v.3.5 and create the following:
</p>

  * <div align="left">
      CBS (REG_DWORD) = 1
    </div>

  * <div align="left">
      Install (REG_DWORD) = 1
    </div>

  * <div align="left">
      SP (REG_DWORD)=1
    </div>

  * <div align="left">
      InstallPath(REG_SZ)=C:\Windows\Microsoft.NET\Framework64\v3.5\
    </div>

  * <div align="left">
      Version(REG_SZ)=3.5.30729.4926
    </div>

<p align="left">
  Now exit the container to stop it.
</p>

<p align="left">
  <strong>WARNING: you’re in RDP do before stop the container do a clean logoff otherwise the container may ended up to not stop in a clean way.</strong>
</p>

<p align="left">
  now commit your new image and remove you’re original container and re-create it or simply create a new one based on the new committed image.
</p>

<h2 align="left">
  Install MSSQL Server 2014 Standard Edition
</h2>

<p align="left">
  Connect back to the container through RDP, insert/mount the MSSQL CD and run the following:
</p>

<p align="left">
  setup.exe /UIMODE=EnableUIOnServerCore /Action=Install
</p>

<p align="left">
  The lovely MSSQL wizard will appear. Remember you’re in a windows core edition so some feature will not work. In my case I’ve installed just the engine it’s all I needed.
</p>

<p align="left">
  Run the wizard, will nicely pass the .net test as per image below
</p>

<p align="left">
  <a href="http://alfweb.com/bg/wp-content/uploads/2015/11/image.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="image" src="http://alfweb.com/bg/wp-content/uploads/2015/11/image_thumb.png" alt="image" width="520" height="419" border="0" /></a>
</p>

<p align="left">
  Simply and nice…looking at the container task list we notice the sqlservr.exe task,in my case with pid 4156
</p>

<p align="left">
  <a href="http://alfweb.com/bg/wp-content/uploads/2015/11/image1.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="image" src="http://alfweb.com/bg/wp-content/uploads/2015/11/image_thumb1.png" alt="image" width="516" height="522" border="0" /></a>
</p>

<p align="left">
  Now looking at the host (I do not use hyper-v mode but default as container mode)
</p>

<p align="left">
  <a href="http://alfweb.com/bg/wp-content/uploads/2015/11/image2.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="image" src="http://alfweb.com/bg/wp-content/uploads/2015/11/image_thumb2.png" alt="image" width="520" height="677" border="0" /></a>
</p>

<p align="left">
  but most of all …
</p>

<p align="left">
  <a href="http://alfweb.com/bg/wp-content/uploads/2015/11/image3.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="image" src="http://alfweb.com/bg/wp-content/uploads/2015/11/image_thumb3.png" alt="image" width="520" height="425" border="0" /></a>
</p>

<p align="left">
  now before actually get out from there you have to run a couple of commands more:
</p>

<p align="left">
  First let’s change the service account for the MSSQL services.
</p>

<p align="left">
  Thanks for this great blog post:
</p>

<p align="left">
  <a title="http://blogs.technet.com/b/heyscriptingguy/archive/2010/11/03/use-powershell-to-change-sql-server-s-service-accounts.aspx" href="http://blogs.technet.com/b/heyscriptingguy/archive/2010/11/03/use-powershell-to-change-sql-server-s-service-accounts.aspx">http://blogs.technet.com/b/heyscriptingguy/archive/2010/11/03/use-powershell-to-change-sql-server-s-service-accounts.aspx</a>
</p>

<p align="left">
  Second we have to enable MSSQL remotely:
</p>

<p align="left">
  <a title="https://msdn.microsoft.com/en-us/library/hh882461.aspx" href="https://msdn.microsoft.com/en-us/library/hh882461.aspx">https://msdn.microsoft.com/en-us/library/hh882461.aspx</a>
</p>

<p align="left">
  <strong>HINT: MSSQL Poershell will fail due the ExecutionPolicy restiction so run the script this way:</strong>
</p>

<p align="left">
  Get-Content .runme.ps1 | PowerShell.exe -noprofile
</p>

<p align="left">
  Logoff from the container, Stop it.Commit the new image
</p>

<p align="left">
  now last part connect to the MSSQL server from outside.
</p>

<p align="left">
  New-NetFirewallRule -Name &#8220;MSSQL&#8221; -DisplayName &#8220;MSSQL Protocol&#8221; -Protocol TCP -LocalPort @(1433) -Action Allow
</p>

<p align="left">
  New-NetFirewallRule -Name &#8220;ContainerMSSQL&#8221; -DisplayName &#8220;MSSQL Port for connecting to Container&#8221; -Protocol TCP -LocalPort @(1434) -Action Allow
</p>

<p align="left">
  <p align="left">
    and finally:
  </p>
  
  <p align="left">
    docker run -it &#8211;name yournewcontainer &#8211;hostname yournewcointaner  -p 1433:1433 containerimage “cmd”
  </p>
  
  <p align="left">
    <p align="left">
      (if new container is d1im-db and the image is d1im-basev5 will be something like
    </p>
    
    <p align="left">
      docker run –it  &#8211;name d1im-db –hostname d1im-db  di1m-basev5 –p 1433:1433  “cmd”
    </p>
    
    <p>
      and bum you’re done. (notice the hostname that is the one docker dynamically created)
    </p>
    
    <p>
      <a href="http://alfweb.com/bg/wp-content/uploads/2015/11/image4.png"><img style="background-image: none; padding-top: 0px; padding-left: 0px; display: inline; padding-right: 0px; border: 0px;" title="image" src="http://alfweb.com/bg/wp-content/uploads/2015/11/image_thumb4.png" alt="image" width="336" height="779" border="0" /></a>
    </p>
    
    <p>
      oh last thing you wondering from where it comes the first line of this blog don’t you?
    </p>
    
    <p>
      here it is:
    </p>
    
    <p>
      <a href="https://youtu.be/yiKFYTFJ_kw">https://youtu.be/yiKFYTFJ_kw</a>
    </p>